<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline';
        style-src 'self' 'unsafe-inline';
        img-src 'self' data:;
        connect-src 'self';
    ">
    <title>Crine - é ­éƒ¨ã‚¤ãƒ©ã‚¹ãƒˆæç”»</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            overflow-x: hidden;
            touch-action: pan-y;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
        }

        .header {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 15px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .header h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .header p {
            font-size: 12px;
            opacity: 0.95;
        }

        .notice-box {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 15px;
            margin: 15px;
            border-radius: 8px;
            font-size: 13px;
            line-height: 1.6;
            color: #856404;
        }

        .notice-box h3 {
            font-size: 14px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #856404;
        }

        .notice-box ul {
            margin-left: 20px;
            margin-top: 8px;
        }

        .notice-box li {
            margin-bottom: 5px;
        }

        .reload-notice {
            background: #f8d7da;
            border-left: 5px solid #dc3545;
            padding: 15px;
            margin: 15px;
            border-radius: 8px;
            font-size: 14px;
            line-height: 1.6;
            color: #721c24;
            display: none;
            animation: pulse 2s infinite;
        }

        .reload-notice h3 {
            font-size: 15px;
            font-weight: 700;
            margin-bottom: 10px;
            color: #721c24;
        }

        .reload-notice strong {
            color: #dc3545;
            font-size: 15px;
        }

        .reload-steps {
            background: white;
            border-radius: 8px;
            padding: 12px;
            margin-top: 10px;
        }

        .reload-steps ol {
            margin-left: 20px;
        }

        .reload-steps li {
            margin-bottom: 8px;
            line-height: 1.5;
        }

        @keyframes pulse {
            0%, 100% {
                opacity: 1;
            }
            50% {
                opacity: 0.85;
            }
        }

        .view-selector {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            padding: 15px;
            background: #f8f9fa;
            overflow-x: auto;
        }

        .view-btn {
            padding: 12px 8px;
            border: 2px solid #ddd;
            border-radius: 10px;
            background: white;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            white-space: nowrap;
        }

        .view-btn.active {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            color: white;
            border-color: #f093fb;
            transform: scale(1.05);
        }

        .canvas-container {
            position: relative;
            width: 100%;
            max-width: 800px;
            margin: 0 auto;
            background: white;
            touch-action: none;
        }

        .canvas-wrapper {
            position: relative;
            width: 100%;
            padding-bottom: 100%;
            overflow: hidden;
        }

        .head-svg {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            pointer-events: none;
            z-index: 1;
        }

        canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            cursor: crosshair;
            z-index: 2;
            touch-action: none;
        }

        .controls {
            padding: 15px;
            background: #f8f9fa;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .control-group {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        .control-group label {
            font-weight: 600;
            font-size: 14px;
            min-width: 60px;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid #ddd;
            border-radius: 50%;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .color-btn.active {
            border-color: #f093fb;
            transform: scale(1.2);
            box-shadow: 0 0 10px rgba(240, 147, 251, 0.5);
        }

        input[type="range"] {
            flex: 1;
            min-width: 150px;
        }

        input[type="text"] {
            flex: 1;
            padding: 10px;
            border: 2px solid #ddd;
            border-radius: 8px;
            font-size: 14px;
        }

        input[type="text"]:focus {
            outline: none;
            border-color: #f093fb;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            padding: 15px;
        }

        .btn {
            padding: 15px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn:active {
            transform: scale(0.95);
        }

        .btn-primary {
            background: linear-gradient(135deg, #00b894, #00cec9);
            color: white;
        }

        .btn-danger {
            background: #ff7675;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
        }

        .btn-warning {
            background: #fdcb6e;
            color: #2d3436;
        }

        @media (max-width: 768px) {
            .view-selector {
                grid-template-columns: repeat(3, 1fr);
                gap: 6px;
                padding: 10px;
            }

            .view-btn {
                padding: 10px 6px;
                font-size: 11px;
            }

            .action-buttons {
                grid-template-columns: 1fr;
            }

            .notice-box {
                font-size: 12px;
                padding: 12px;
                margin: 10px;
            }

            .reload-notice {
                font-size: 13px;
                padding: 12px;
                margin: 10px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ¨ é ­éƒ¨ã‚¤ãƒ©ã‚¹ãƒˆæç”»ã‚¢ãƒ—ãƒª</h1>
            <p id="customerInfo">é¡§å®¢æƒ…å ±ã‚’èª­ã¿è¾¼ã¿ä¸­...</p>
        </div>

        <div class="notice-box">
            <h3>âš ï¸ ã”ä½¿ç”¨å‰ã®æ³¨æ„äº‹é …</h3>
            <ul>
                <li><strong>ä¿å­˜ã‚’å¿˜ã‚Œãšã«ï¼š</strong>æç”»å¾Œã¯å¿…ãšã€ŒğŸ’¾ ä¿å­˜ã€ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</li>
                <li><strong>ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆæ™‚ï¼š</strong>åˆ¥ã®è§’åº¦ã«åˆ‡ã‚Šæ›¿ãˆã‚‹ã¨è‡ªå‹•ä¿å­˜ã•ã‚Œã¾ã™</li>
                <li><strong>iPadã§ã®è¡¨ç¤ºå•é¡Œï¼š</strong>ã‚¤ãƒ©ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆã¯ä¸‹è¨˜ã®æ–¹æ³•ã§å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„</li>
                <li><strong>æç”»ã®ã‚³ãƒ„ï¼š</strong>æŒ‡ã¾ãŸã¯ãƒšãƒ³ã§ç›´æ¥ç”»é¢ã‚’ã‚¿ãƒƒãƒã—ã¦æç”»ã§ãã¾ã™</li>
                <li><strong>å–ã‚Šæ¶ˆã—æ©Ÿèƒ½ï¼š</strong>é–“é•ãˆãŸå ´åˆã¯ã€Œâ†¶ æˆ»ã‚‹ã€ãƒœã‚¿ãƒ³ã§1ã¤å‰ã«æˆ»ã‚Œã¾ã™</li>
            </ul>
        </div>

        <div class="reload-notice" id="reloadNotice">
            <h3>ğŸ”„ é ­éƒ¨ã‚¤ãƒ©ã‚¹ãƒˆãŒè¡¨ç¤ºã•ã‚Œãªã„å ´åˆ</h3>
            <p><strong>ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‹ã‚‰å¼·åˆ¶å†èª­ã¿è¾¼ã¿ã‚’å®Ÿè¡Œã—ã¦ãã ã•ã„ï¼š</strong></p>
            <div class="reload-steps">
                <ol>
                    <li><strong>iPhone/iPad (Safari)</strong><br>
                        ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã®ğŸ”„ï¼ˆæ›´æ–°ãƒœã‚¿ãƒ³ï¼‰ã‚’é•·æŠ¼ã— â†’ ã€Œãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨Webã‚µã‚¤ãƒˆã‚’è¡¨ç¤ºã€ã‚’ã‚¿ãƒƒãƒ—</li>
                    <li><strong>ã¾ãŸã¯ã€</strong><br>
                        ã‚¢ãƒ‰ãƒ¬ã‚¹ãƒãƒ¼ã‚’ã‚¿ãƒƒãƒ— â†’ ã‚­ãƒ¼ãƒœãƒ¼ãƒ‰ã®ã€Œé–‹ãã€ã‚’ã‚¿ãƒƒãƒ—</li>
                    <li><strong>Android (Chrome)</strong><br>
                        ãƒ¡ãƒ‹ãƒ¥ãƒ¼ï¼ˆâ‹®ï¼‰â†’ã€Œãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ã‚µã‚¤ãƒˆã€ã«ãƒã‚§ãƒƒã‚¯</li>
                    <li><strong>PC (å…¨ãƒ–ãƒ©ã‚¦ã‚¶)</strong><br>
                        Ctrl + Shift + R (Windows)<br>
                        Command + Shift + R (Mac)</li>
                </ol>
            </div>
        </div>

        <div class="view-selector" id="viewSelector"></div>

        <div class="canvas-container">
            <div class="canvas-wrapper">
                <img id="headSvg" class="head-svg" alt="é ­éƒ¨ã‚¤ãƒ©ã‚¹ãƒˆ">
                <canvas id="drawingCanvas"></canvas>
            </div>
        </div>

        <div class="controls">
            <div class="control-group">
                <label>è‰²:</label>
                <div style="display:flex;gap:8px;flex-wrap:wrap;">
                    <div class="color-btn active" data-color="#000000" style="background:#000000;" title="é»’"></div>
                    <div class="color-btn" data-color="#FF0000" style="background:#FF0000;" title="èµ¤"></div>
                    <div class="color-btn" data-color="#0000FF" style="background:#0000FF;" title="é’"></div>
                    <div class="color-btn" data-color="#00FF00" style="background:#00FF00;" title="ç·‘"></div>
                    <div class="color-btn" data-color="#FFFF00" style="background:#FFFF00;" title="é»„"></div>
                    <div class="color-btn" data-color="#FF00FF" style="background:#FF00FF;" title="ç´«"></div>
                </div>
            </div>

            <div class="control-group">
                <label>å¤ªã•:</label>
                <input type="range" id="brushSize" min="1" max="20" value="3">
                <span id="brushSizeValue">3px</span>
            </div>

            <div class="control-group">
                <label>ãƒ¡ãƒ¢:</label>
                <input type="text" id="drawingMemo" placeholder="ã“ã®æç”»ã«é–¢ã™ã‚‹ãƒ¡ãƒ¢ï¼ˆä»»æ„ï¼‰">
            </div>
        </div>

        <div class="action-buttons">
            <button class="btn btn-primary" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
            <button class="btn btn-danger" id="clearBtn">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
            <button class="btn btn-warning" id="undoBtn">â†¶ æˆ»ã‚‹</button>
            <button class="btn btn-secondary" id="backBtn">â† ãƒ¡ã‚¤ãƒ³ã¸</button>
        </div>
    </div>

    <script>
        let canvas, ctx;
        let isDrawing = false;
        let currentColor = '#000000';
        let currentBrushSize = 3;
        let currentView = 'front';
        let customerId = null;
        let drawingHistory = {};
        let currentStrokes = [];
        let imageLoadAttempts = 0;
        const MAX_LOAD_ATTEMPTS = 3;

        const views = [
            { id: 'front', label: 'æ­£é¢', file: 'head-front.svg' },
            { id: 'back', label: 'å¾Œã‚', file: 'head-back.svg' },
            { id: 'left', label: 'å·¦', file: 'head-left.svg' },
            { id: 'right', label: 'å³', file: 'head-right.svg' },
            { id: 'top', label: 'ä¸Š', file: 'head-top.svg' },
            { id: 'diagonal-left', label: 'æ–œã‚å·¦å‰', file: 'head-diagonal-left.svg' },
            { id: 'diagonal-right', label: 'æ–œã‚å³å‰', file: 'head-diagonal-right.svg' },
            { id: 'diagonal-left-back', label: 'æ–œã‚å·¦å¾Œ', file: 'head-diagonal-left-back.svg' },
            { id: 'diagonal-right-back', label: 'æ–œã‚å³å¾Œ', file: 'head-diagonal-right-back.svg' }
        ];

        window.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) return;
            
            const urlParams = new URLSearchParams(window.location.search);
            customerId = urlParams.get('id');
            
            if (!customerId) {
                alert('é¡§å®¢IDãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
                window.location.href = 'index.html';
                return;
            }

            loadCustomerInfo();
            initCanvas();
            createViewButtons();
            loadDrawingData();
            setupEventListeners();
            loadView('front');
        });

        function checkAuth() {
            const authInfo = localStorage.getItem('salonLicense');
            if (!authInfo) {
                alert('ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‹ã‚‰èµ·å‹•ã—ã¦ãã ã•ã„');
                window.location.href = 'index.html';
                return false;
            }
            try {
                const auth = JSON.parse(authInfo);
                if (new Date(auth.validUntil) < new Date()) {
                    alert('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™');
                    localStorage.removeItem('salonLicense');
                    window.location.href = 'license.html';
                    return false;
                }
                return true;
            } catch (e) {
                console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', e);
                return false;
            }
        }

        function loadCustomerInfo() {
            const customers = JSON.parse(localStorage.getItem('salonCustomersFree') || '[]');
            const customer = customers.find(c => c.id === customerId);
            
            if (customer) {
                document.getElementById('customerInfo').textContent = 
                    `${customer.name}æ§˜ (ID: ${customer.id})`;
            }
        }

        function initCanvas() {
            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            
            const container = canvas.parentElement;
            const size = container.offsetWidth;
            
            canvas.width = size * 2;
            canvas.height = size * 2;
            canvas.style.width = size + 'px';
            canvas.style.height = size + 'px';
            
            ctx.scale(2, 2);
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
        }

        function createViewButtons() {
            const selector = document.getElementById('viewSelector');
            views.forEach(view => {
                const btn = document.createElement('button');
                btn.className = 'view-btn';
                btn.textContent = view.label;
                btn.dataset.view = view.id;
                if (view.id === 'front') btn.classList.add('active');
                btn.onclick = () => switchView(view.id);
                selector.appendChild(btn);
            });
        }

        function switchView(viewId) {
            saveCurrentDrawing();
            currentView = viewId;
            
            document.querySelectorAll('.view-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.view === viewId);
            });
            
            loadView(viewId);
        }

        function loadView(viewId) {
            const view = views.find(v => v.id === viewId);
            if (!view) return;
            
            const img = document.getElementById('headSvg');
            const reloadNotice = document.getElementById('reloadNotice');
            
            img.onload = function() {
                console.log('SVGèª­ã¿è¾¼ã¿æˆåŠŸ:', view.file);
                imageLoadAttempts = 0;
                reloadNotice.style.display = 'none';
                loadViewDrawing(viewId);
            };
            
            img.onerror = function() {
                console.error('SVGèª­ã¿è¾¼ã¿å¤±æ•—:', view.file);
                imageLoadAttempts++;
                
                if (imageLoadAttempts >= MAX_LOAD_ATTEMPTS) {
                    reloadNotice.style.display = 'block';
                    window.scrollTo({ top: reloadNotice.offsetTop - 100, behavior: 'smooth' });
                }
            };
            
            img.src = `images/${view.file}`;
        }

        function saveCurrentDrawing() {
            if (currentStrokes.length > 0) {
                drawingHistory[currentView] = [...currentStrokes];
            }
        }

        function loadViewDrawing(viewId) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentStrokes = drawingHistory[viewId] ? [...drawingHistory[viewId]] : [];
            redrawCanvas();
        }

        function redrawCanvas() {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            currentStrokes.forEach(stroke => {
                drawStroke(stroke);
            });
        }

        function drawStroke(stroke) {
            ctx.strokeStyle = stroke.color;
            ctx.lineWidth = stroke.size;
            ctx.beginPath();
            stroke.points.forEach((point, index) => {
                if (index === 0) {
                    ctx.moveTo(point.x, point.y);
                } else {
                    ctx.lineTo(point.x, point.y);
                }
            });
            ctx.stroke();
        }

        function setupEventListeners() {
            document.querySelectorAll('.color-btn').forEach(btn => {
                btn.addEventListener('click', function() {
                    document.querySelectorAll('.color-btn').forEach(b => b.classList.remove('active'));
                    this.classList.add('active');
                    currentColor = this.dataset.color;
                });
            });

            const brushSize = document.getElementById('brushSize');
            brushSize.addEventListener('input', function() {
                currentBrushSize = parseInt(this.value);
                document.getElementById('brushSizeValue').textContent = currentBrushSize + 'px';
            });

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', handleTouchStart, { passive: false });
            canvas.addEventListener('touchmove', handleTouchMove, { passive: false });
            canvas.addEventListener('touchend', stopDrawing);

            document.getElementById('saveBtn').addEventListener('click', saveDrawing);
            document.getElementById('clearBtn').addEventListener('click', clearCanvas);
            document.getElementById('undoBtn').addEventListener('click', undo);
            document.getElementById('backBtn').addEventListener('click', () => {
                window.location.href = 'index.html';
            });
        }

        function getCoordinates(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            
            return {
                x: (e.clientX - rect.left) * scaleX / 2,
                y: (e.clientY - rect.top) * scaleY / 2
            };
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousedown', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const mouseEvent = new MouseEvent('mousemove', {
                clientX: touch.clientX,
                clientY: touch.clientY
            });
            canvas.dispatchEvent(mouseEvent);
        }

        let currentStroke = null;

        function startDrawing(e) {
            isDrawing = true;
            const pos = getCoordinates(e);
            currentStroke = {
                color: currentColor,
                size: currentBrushSize,
                points: [pos]
            };
        }

        function draw(e) {
            if (!isDrawing || !currentStroke) return;
            
            const pos = getCoordinates(e);
            currentStroke.points.push(pos);
            
            ctx.strokeStyle = currentColor;
            ctx.lineWidth = currentBrushSize;
            ctx.beginPath();
            const lastPoint = currentStroke.points[currentStroke.points.length - 2];
            ctx.moveTo(lastPoint.x, lastPoint.y);
            ctx.lineTo(pos.x, pos.y);
            ctx.stroke();
        }

        function stopDrawing() {
            if (isDrawing && currentStroke && currentStroke.points.length > 1) {
                currentStrokes.push(currentStroke);
            }
            isDrawing = false;
            currentStroke = null;
        }

        function clearCanvas() {
            if (!confirm('ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã®æç”»ã‚’ã‚¯ãƒªã‚¢ã—ã¾ã™ã‹ï¼Ÿ')) return;
            
            currentStrokes = [];
            drawingHistory[currentView] = [];
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function undo() {
            if (currentStrokes.length === 0) return;
            
            currentStrokes.pop();
            drawingHistory[currentView] = [...currentStrokes];
            redrawCanvas();
        }

        function loadDrawingData() {
            const data = localStorage.getItem('drawing_' + customerId);
            if (data) {
                try {
                    const saved = JSON.parse(data);
                    if (saved.drawings) {
                        Object.keys(saved.drawings).forEach(viewId => {
                            if (saved.drawings[viewId] && saved.drawings[viewId].length > 0) {
                                drawingHistory[viewId] = saved.drawings[viewId][saved.drawings[viewId].length - 1];
                            }
                        });
                    }
                } catch (e) {
                    console.error('æç”»ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿ã‚¨ãƒ©ãƒ¼:', e);
                }
            }
        }

        function saveDrawing() {
            saveCurrentDrawing();
            
            const memo = document.getElementById('drawingMemo').value;
            
            const allDrawings = {};
            Object.keys(drawingHistory).forEach(viewId => {
                if (drawingHistory[viewId] && drawingHistory[viewId].length > 0) {
                    allDrawings[viewId] = [drawingHistory[viewId]];
                }
            });
            
            const data = {
                customerId: customerId,
                drawings: allDrawings,
                memo: memo,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('drawing_' + customerId, JSON.stringify(data));
            alert('æç”»ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }
    </script>
</body>
</html>
