<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta http-equiv="Content-Security-Policy" content="
        default-src 'self';
        script-src 'self' 'unsafe-inline' https://pagead2.googlesyndication.com;
        style-src 'self' 'unsafe-inline';
        img-src 'self' data: https:;
        connect-src 'self';
    ">
    <title>Crine Free - æç”»ã‚¢ãƒ—ãƒª</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 10px;
            min-height: 100vh;
        }

        .container {
            max-width: 100%;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            padding: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
        }

        h1 {
            color: #667eea;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.5em;
        }

        .customer-info {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
            color: #1976d2;
        }

        .view-buttons {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 8px;
            margin: 15px 0;
        }

        .view-buttons button {
            padding: 10px;
            background: #f0f0f0;
            color: #333;
            font-size: 13px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s;
        }

        .view-buttons button.active {
            background: linear-gradient(135deg, #48c6ef, #6f86d6);
            color: white;
        }

        .view-buttons button:hover {
            transform: translateY(-2px);
        }

        .tools {
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 8px;
            margin: 15px 0;
            padding: 15px;
            background: #f8f9fa;
            border-radius: 10px;
        }

        .tools button {
            padding: 10px 8px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 13px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .tools button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .tools button.active {
            background: #764ba2;
            box-shadow: 0 4px 12px rgba(118, 75, 162, 0.4);
        }

        .color-palette {
            grid-column: 1 / -1;
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            justify-content: center;
        }

        .color-btn {
            width: 40px;
            height: 40px;
            border: 3px solid transparent;
            border-radius: 8px;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .color-btn:hover {
            transform: scale(1.1);
        }

        .color-btn.active {
            border-color: #333;
            transform: scale(1.15);
        }

        .width-control {
            grid-column: 1 / -1;
            display: flex;
            align-items: center;
            gap: 10px;
            justify-content: center;
        }

        .width-control label {
            font-weight: 600;
            white-space: nowrap;
        }

        .width-control input {
            width: 150px;
        }

        .width-control span {
            font-weight: 600;
            color: #667eea;
            min-width: 45px;
        }

        .canvas-container {
            margin: 15px 0;
            text-align: center;
            position: relative;
            display: inline-block;
            width: 100%;
        }

        #drawingCanvas {
            border: 3px solid #667eea;
            border-radius: 10px;
            cursor: crosshair;
            background: white;
            touch-action: none;
            max-width: 100%;
            height: auto;
            display: block;
            margin: 0 auto;
        }

        .text-overlay {
            position: absolute;
            background: rgba(255, 255, 255, 0.85);
            padding: 3px 6px;
            border-radius: 3px;
            font-size: 11px;
            cursor: move;
            border: 1px solid #ccc;
            user-select: none;
            pointer-events: auto;
        }

        .text-overlay:hover {
            background: rgba(255, 255, 255, 0.95);
        }

        .delete-text {
            color: red;
            cursor: pointer;
            margin-left: 5px;
            font-weight: bold;
            font-size: 16px;
            padding: 2px 6px;
            pointer-events: auto;
            display: inline-block;
            user-select: none;
            -webkit-tap-highlight-color: transparent;
        }

        .text-input-box {
            position: absolute;
            background: white;
            border: 2px solid #667eea;
            border-radius: 5px;
            padding: 5px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .text-input-box input {
            border: 1px solid #ddd;
            padding: 5px;
            font-size: 12px;
            width: 150px;
            border-radius: 3px;
        }

        .text-input-box button {
            margin-left: 5px;
            padding: 5px 10px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 3px;
            cursor: pointer;
            font-size: 11px;
        }

        .bottom-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            justify-content: center;
            margin: 15px 0;
        }

        .bottom-tools button {
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 15px;
            font-weight: 600;
            transition: all 0.3s;
        }

        .bottom-tools button:hover {
            background: #764ba2;
            transform: translateY(-2px);
        }

        .clear-btn {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%) !important;
        }

        .clear-btn:hover {
            background: linear-gradient(135deg, #e082ea 0%, #e4465b 100%) !important;
        }

        .undo-counter {
            background: linear-gradient(135deg, #e3f2fd, #f3e5f5);
            color: #1976d2;
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            display: flex;
            align-items: center;
        }

        .back-btn {
            background: #6c757d !important;
            margin-top: 20px;
        }

        .back-btn:hover {
            background: #5a6268 !important;
        }

        .ad-container {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
        }

        .ad-content {
            min-height: 90px;
            background: #e9ecef;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 5px;
        }

        .loading-indicator {
            background: #fff3cd;
            border-left: 5px solid #ffc107;
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
            font-size: 13px;
            color: #856404;
        }

        @media (min-width: 768px) {
            h1 {
                font-size: 2em;
            }

            .view-buttons {
                grid-template-columns: repeat(3, 1fr);
            }

            #drawingCanvas {
                width: 500px;
                height: 500px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ¨ Crine Free æç”»ã‚¢ãƒ—ãƒª</h1>

        <div class="loading-indicator" id="loadingIndicator">
            ğŸ“¥ ç”»åƒã‚’èª­ã¿è¾¼ã‚“ã§ã„ã¾ã™...
        </div>

        <div class="ad-container">
            <div class="ad-content">
                <p style="color: #6c757d; font-size: 12px;">ğŸ“¢ åºƒå‘Šã‚¹ãƒšãƒ¼ã‚¹</p>
            </div>
        </div>

        <div class="customer-info" id="customerInfo">
            é¡§å®¢ID: èª­ã¿è¾¼ã¿ä¸­...
        </div>

        <div class="view-buttons">
            <button class="view-btn active" onclick="changeView('front')">æ­£é¢</button>
            <button class="view-btn" onclick="changeView('back')">å¾Œã‚</button>
            <button class="view-btn" onclick="changeView('left')">å·¦å´é¢</button>
            <button class="view-btn" onclick="changeView('right')">å³å´é¢</button>
            <button class="view-btn" onclick="changeView('top')">ä¸Šã‹ã‚‰</button>
            <button class="view-btn" onclick="changeView('diagonal-left')">æ–œã‚å·¦</button>
            <button class="view-btn" onclick="changeView('diagonal-right')">æ–œã‚å³</button>
            <button class="view-btn" onclick="changeView('diagonal-left-back')">æ–œã‚å·¦å¾Œã‚</button>
            <button class="view-btn" onclick="changeView('diagonal-right-back')">æ–œã‚å³å¾Œã‚</button>
        </div>

        <div class="tools">
            <button class="active" id="penBtn" onclick="setTool('pen')">ğŸ–Šï¸ ãƒšãƒ³</button>
            <button id="eraserBtn" onclick="setTool('eraser')">ğŸ§¹ æ¶ˆã—ã‚´ãƒ </button>
            <button id="textBtn" onclick="addText()">ğŸ“ ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ </button>
            
            <div class="color-palette">
                <div class="color-btn active" style="background: black;" onclick="setColor('black')"></div>
                <div class="color-btn" style="background: red;" onclick="setColor('red')"></div>
                <div class="color-btn" style="background: blue;" onclick="setColor('blue')"></div>
                <div class="color-btn" style="background: green;" onclick="setColor('green')"></div>
                <div class="color-btn" style="background: orange;" onclick="setColor('orange')"></div>
                <div class="color-btn" style="background: purple;" onclick="setColor('purple')"></div>
            </div>

            <div class="width-control">
                <label>å¤ªã•:</label>
                <input type="range" id="lineWidth" min="1" max="25" value="3" oninput="updateLineWidth(this.value)">
                <span id="widthValue">3px</span>
            </div>
        </div>

        <div class="canvas-container" id="canvasContainer">
            <canvas id="drawingCanvas" width="500" height="500"></canvas>
        </div>

        <div class="bottom-tools">
            <button onclick="undo()">â†¶ æˆ»ã‚‹</button>
            <button onclick="redo()">â†· ã‚„ã‚Šç›´ã—</button>
            <button class="clear-btn" onclick="clearCurrentView()">ğŸ—‘ï¸ ã‚¯ãƒªã‚¢</button>
            <span class="undo-counter" id="undoCounter">Undo: 0/5å›</span>
        </div>

        <div class="bottom-tools">
            <button onclick="saveDrawing()">ğŸ’¾ ä¿å­˜</button>
            <button class="back-btn" id="backToMainBtn">â† ã‚«ãƒ«ãƒ†ã«æˆ»ã‚‹</button>
        </div>
    </div>

    <script>
        // ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        let canvas, ctx;
        let isDrawing = false;
        let currentTool = 'pen';
        let currentColor = 'black';
        let lineWidth = 3;
        let currentView = 'front';
        let undoStacks = {};
        let redoStacks = {};
        let customerId = '';
        let textElements = {};
        let longPressTimer = null;
        let longPressStartX = 0;
        let longPressStartY = 0;
        const MAX_UNDO = 5;
        const LONG_PRESS_DURATION = 500;

        // ç”»åƒã‚­ãƒ£ãƒƒã‚·ãƒ¥
        let imageCache = {};
        let imagesLoaded = 0;
        const totalImages = 9;

        // èªè¨¼ãƒã‚§ãƒƒã‚¯
        function checkAuth() {
            const authInfo = localStorage.getItem('salonLicense');
            
            if (!authInfo) {
                alert('ãƒ¡ã‚¤ãƒ³ã‚¢ãƒ—ãƒªã‹ã‚‰èµ·å‹•ã—ã¦ãã ã•ã„');
                window.location.href = 'index.html';
                return false;
            }
            
            return true;
        }

        // åˆæœŸåŒ–
        window.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) {
                return;
            }
            
            const params = new URLSearchParams(window.location.search);
            customerId = params.get('id') || 'GUEST';
            document.getElementById('customerInfo').textContent = `é¡§å®¢ID: ${customerId} | Crine Freeç‰ˆï¼šUndo 5å›ã¾ã§`;

            canvas = document.getElementById('drawingCanvas');
            ctx = canvas.getContext('2d');
            ctx.lineCap = 'round';
            ctx.lineJoin = 'round';
            
            const views = ['front', 'back', 'left', 'right', 'top', 'diagonal-left', 'diagonal-right', 'diagonal-left-back', 'diagonal-right-back'];
            views.forEach(view => {
                undoStacks[view] = [];
                redoStacks[view] = [];
                textElements[view] = [];
            });
            
            // ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰
            preloadImages();
            
            setupEventListeners();
            
            const saved = localStorage.getItem('drawing_' + customerId);
            if (saved) {
                loadDrawing();
            }
            
            updateUndoCounter();
        });

        // ç”»åƒãƒ—ãƒªãƒ­ãƒ¼ãƒ‰æ©Ÿèƒ½
        function preloadImages() {
            const imageFiles = {
                'front': 'images/head-front.svg',
                'back': 'images/head-back.svg',
                'left': 'images/head-left.svg',
                'right': 'images/head-right.svg',
                'top': 'images/head-top.svg',
                'diagonal-left': 'images/head-diagonal-left.svg',
                'diagonal-right': 'images/head-diagonal-right.svg',
                'diagonal-left-back': 'images/head-diagonal-left-back.svg',
                'diagonal-right-back': 'images/head-diagonal-right-back.svg'
            };

            Object.keys(imageFiles).forEach(view => {
                const img = new Image();
                img.crossOrigin = "anonymous";
                
                img.onload = function() {
                    imageCache[view] = this;
                    imagesLoaded++;
                    console.log(`âœ… ç”»åƒèª­ã¿è¾¼ã¿æˆåŠŸ: ${view} (${imagesLoaded}/${totalImages})`);
                    
                    if (imagesLoaded === totalImages) {
                        document.getElementById('loadingIndicator').style.display = 'none';
                        console.log('âœ… å…¨ç”»åƒã®èª­ã¿è¾¼ã¿å®Œäº†');
                        
                        // åˆæœŸãƒ“ãƒ¥ãƒ¼æç”»
                        if (!undoStacks[currentView] || undoStacks[currentView].length === 0) {
                            drawHeadOutline(currentView);
                            saveState();
                        }
                    }
                    
                    // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã®ç”»åƒãŒèª­ã¿è¾¼ã¾ã‚ŒãŸã‚‰å³åº§ã«è¡¨ç¤º
                    if (view === currentView) {
                        drawHeadOutline(currentView);
                        if (undoStacks[currentView] && undoStacks[currentView].length === 0) {
                            saveState();
                        }
                    }
                };
                
                img.onerror = function() {
                    console.error(`âŒ ç”»åƒèª­ã¿è¾¼ã¿å¤±æ•—: ${view} - ${imageFiles[view]}`);
                    imagesLoaded++;
                    
                    if (imagesLoaded === totalImages) {
                        document.getElementById('loadingIndicator').innerHTML = 
                            'âš ï¸ ä¸€éƒ¨ã®ç”»åƒãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã§ã—ãŸã€‚ãƒšãƒ¼ã‚¸ã‚’å†èª­ã¿è¾¼ã¿ã—ã¦ãã ã•ã„ã€‚';
                        document.getElementById('loadingIndicator').style.background = '#f8d7da';
                        document.getElementById('loadingIndicator').style.borderColor = '#dc3545';
                        document.getElementById('loadingIndicator').style.color = '#721c24';
                    }
                };
                
                img.src = imageFiles[view] + '?v=' + Date.now();
            });
        }

        // èƒŒæ™¯ç”»åƒæç”»
        function drawHeadOutline(view) {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            ctx.fillStyle = 'white';
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            
            if (imageCache[view]) {
                const img = imageCache[view];
                const scale = Math.min(canvas.width / img.width, canvas.height / img.height) * 0.85;
                const x = (canvas.width - img.width * scale) / 2;
                const y = (canvas.height - img.height * scale) / 2;
                
                ctx.drawImage(img, x, y, img.width * scale, img.height * scale);
                console.log(`âœ… ãƒ“ãƒ¥ãƒ¼æç”»å®Œäº†: ${view}`);
            } else {
                // ç”»åƒãŒæœªãƒ­ãƒ¼ãƒ‰ã®å ´åˆã¯ãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼
                ctx.fillStyle = '#f8f9fa';
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                ctx.strokeStyle = '#dee2e6';
                ctx.lineWidth = 2;
                ctx.strokeRect(20, 20, canvas.width - 40, canvas.height - 40);
                
                ctx.fillStyle = '#6c757d';
                ctx.font = 'bold 16px sans-serif';
                ctx.textAlign = 'center';
                ctx.fillText('ğŸ“¥ ç”»åƒèª­ã¿è¾¼ã¿ä¸­...', canvas.width / 2, canvas.height / 2);
                
                console.warn(`âš ï¸ ç”»åƒæœªãƒ­ãƒ¼ãƒ‰: ${view}`);
            }
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼è¨­å®š
        function setupEventListeners() {
            canvas.addEventListener('mousedown', handleMouseDown);
            canvas.addEventListener('mousemove', handleMouseMove);
            canvas.addEventListener('mouseup', handleMouseUp);
            canvas.addEventListener('mouseout', handleMouseUp);
            canvas.addEventListener('touchstart', handleTouchStart, {passive: false});
            canvas.addEventListener('touchmove', handleTouchMove, {passive: false});
            canvas.addEventListener('touchend', handleTouchEnd);
            
            document.getElementById('backToMainBtn').addEventListener('click', backToMain);
        }

        // ãƒã‚¦ã‚¹/ã‚¿ãƒƒãƒã‚¤ãƒ™ãƒ³ãƒˆå‡¦ç†
        function handleMouseDown(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            
            longPressStartX = e.clientX - rect.left;
            longPressStartY = e.clientY - rect.top;
            
            longPressTimer = setTimeout(() => {
                showTextInput(longPressStartX, longPressStartY);
            }, LONG_PRESS_DURATION);
            
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function handleMouseMove(e) {
            if (longPressTimer && isDrawing) {
                const moved = Math.abs(e.clientX - canvas.getBoundingClientRect().left - longPressStartX) > 10 ||
                             Math.abs(e.clientY - canvas.getBoundingClientRect().top - longPressStartY) > 10;
                if (moved) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }
            
            if (!isDrawing || longPressTimer) return;
            
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (e.clientX - rect.left) * scaleX;
            const y = (e.clientY - rect.top) * scaleY;
            ctx.strokeStyle = currentTool === 'eraser' ? 'white' : currentColor;
            ctx.lineWidth = currentTool === 'eraser' ? lineWidth * 3 : lineWidth;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function handleMouseUp() {
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (isDrawing && !longPressTimer) {
                isDrawing = false;
                saveState();
            }
            isDrawing = false;
        }

        function handleTouchStart(e) {
            e.preventDefault();
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (touch.clientX - rect.left) * scaleX;
            const y = (touch.clientY - rect.top) * scaleY;
            
            longPressStartX = touch.clientX - rect.left;
            longPressStartY = touch.clientY - rect.top;
            
            longPressTimer = setTimeout(() => {
                showTextInput(longPressStartX, longPressStartY);
                isDrawing = false;
            }, LONG_PRESS_DURATION);
            
            isDrawing = true;
            ctx.beginPath();
            ctx.moveTo(x, y);
        }

        function handleTouchMove(e) {
            e.preventDefault();
            
            if (longPressTimer && isDrawing) {
                const touch = e.touches[0];
                const rect = canvas.getBoundingClientRect();
                const moved = Math.abs(touch.clientX - rect.left - longPressStartX) > 10 ||
                             Math.abs(touch.clientY - rect.top - longPressStartY) > 10;
                if (moved) {
                    clearTimeout(longPressTimer);
                    longPressTimer = null;
                }
            }
            
            if (!isDrawing || longPressTimer) return;
            
            const touch = e.touches[0];
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            const x = (touch.clientX - rect.left) * scaleX;
            const y = (touch.clientY - rect.top) * scaleY;
            
            ctx.strokeStyle = currentTool === 'eraser' ? 'white' : currentColor;
            ctx.lineWidth = currentTool === 'eraser' ? lineWidth * 3 : lineWidth;
            ctx.lineTo(x, y);
            ctx.stroke();
        }

        function handleTouchEnd(e) {
            e.preventDefault();
            if (longPressTimer) {
                clearTimeout(longPressTimer);
                longPressTimer = null;
            }
            if (isDrawing && !longPressTimer) {
                isDrawing = false;
                saveState();
            }
            isDrawing = false;
        }

        // ãƒ“ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
        function changeView(view) {
            currentView = view;
            document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            if (!undoStacks[view]) {
                undoStacks[view] = [];
                redoStacks[view] = [];
                textElements[view] = [];
            }
            
            if (undoStacks[view].length > 0) {
                const img = new Image();
                img.onload = function() {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    ctx.drawImage(img, 0, 0);
                };
                img.src = undoStacks[view][undoStacks[view].length - 1];
            } else {
                drawHeadOutline(view);
                saveState();
            }
            
            renderTextElements();
            updateUndoCounter();
        }

        // ç¾åœ¨ã®ãƒ“ãƒ¥ãƒ¼ã‚’ã‚¯ãƒªã‚¢
        function clearCurrentView() {
            if (confirm(`ç¾åœ¨ã®ã€Œ${getViewName(currentView)}ã€ãƒ“ãƒ¥ãƒ¼ã®æç”»å†…å®¹ã‚’å…¨ã¦å‰Šé™¤ã—ã¾ã™ã‹?\n\nâ€»ã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“`)) {
                // ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’ã‚¯ãƒªã‚¢ã—ã¦èƒŒæ™¯ç”»åƒã‚’å†æç”»
                drawHeadOutline(currentView);
                
                // Undoå±¥æ­´ã‚’ã‚¯ãƒªã‚¢ï¼ˆåˆæœŸçŠ¶æ…‹ã®ã¿æ®‹ã™ï¼‰
                undoStacks[currentView] = [];
                redoStacks[currentView] = [];
                
                // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ã‚’ã‚¯ãƒªã‚¢
                textElements[currentView] = [];
                renderTextElements();
                
                // æ–°ã—ã„åˆæœŸçŠ¶æ…‹ã‚’ä¿å­˜
                saveState();
                
                alert('âœ… ã‚¯ãƒªã‚¢ã—ã¾ã—ãŸ');
            }
        }

        // ãƒ“ãƒ¥ãƒ¼åå–å¾—
        function getViewName(view) {
            const viewNames = {
                'front': 'æ­£é¢',
                'back': 'å¾Œã‚',
                'left': 'å·¦å´é¢',
                'right': 'å³å´é¢',
                'top': 'ä¸Šã‹ã‚‰',
                'diagonal-left': 'æ–œã‚å·¦',
                'diagonal-right': 'æ–œã‚å³',
                'diagonal-left-back': 'æ–œã‚å·¦å¾Œã‚',
                'diagonal-right-back': 'æ–œã‚å³å¾Œã‚'
            };
            return viewNames[view] || view;
        }

        // ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ãƒ€ã‚¤ã‚¢ãƒ­ã‚°è¡¨ç¤º
        function showTextInput(x, y) {
            const container = document.getElementById('canvasContainer');
            
            const existing = document.querySelector('.text-input-box');
            if (existing) existing.remove();
            
            const inputBox = document.createElement('div');
            inputBox.className = 'text-input-box';
            inputBox.style.left = x + 'px';
            inputBox.style.top = y + 'px';
            
            const input = document.createElement('input');
            input.type = 'text';
            input.placeholder = 'ãƒ¡ãƒ¢å…¥åŠ›';
            
            const addBtn = document.createElement('button');
            addBtn.textContent = 'è¿½åŠ ';
            addBtn.onclick = () => {
                if (input.value.trim()) {
                    createTextElement(input.value, x, y);
                }
                inputBox.remove();
            };
            
            const cancelBtn = document.createElement('button');
            cancelBtn.textContent = 'Ã—';
            cancelBtn.style.background = '#999';
            cancelBtn.onclick = () => inputBox.remove();
            
            inputBox.appendChild(input);
            inputBox.appendChild(addBtn);
            inputBox.appendChild(cancelBtn);
            container.appendChild(inputBox);
            
            input.focus();
            input.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    addBtn.click();
                }
            });
        }

        // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ä½œæˆ
        function createTextElement(text, x, y) {
            const container = document.getElementById('canvasContainer');
            
            const textEl = document.createElement('div');
            textEl.className = 'text-overlay';
            
            const textSpan = document.createElement('span');
            textSpan.textContent = text;
            
            const deleteBtn = document.createElement('span');
            deleteBtn.className = 'delete-text';
            deleteBtn.textContent = 'Ã—';
            deleteBtn.addEventListener('click', function(e) {
                e.preventDefault();
                e.stopPropagation();
                deleteTextElement(textEl, text);
            });
            deleteBtn.addEventListener('touchend', function(e) {
                e.preventDefault();
                e.stopPropagation();
                deleteTextElement(textEl, text);
            });
            
            textEl.appendChild(textSpan);
            textEl.appendChild(deleteBtn);
            textEl.style.position = 'absolute';
            textEl.style.left = x + 'px';
            textEl.style.top = y + 'px';
            
            makeTextDraggable(textEl);
            container.appendChild(textEl);
            
            if (!textElements[currentView]) textElements[currentView] = [];
            textElements[currentView].push({
                text: text,
                left: x + 'px',
                top: y + 'px'
            });
        }

        // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ å‰Šé™¤
        function deleteTextElement(element, text) {
            if (textElements[currentView]) {
                textElements[currentView] = textElements[currentView].filter(t => t.text !== text);
            }
            element.remove();
        }

        // ãƒ†ã‚­ã‚¹ãƒˆãƒ‰ãƒ©ãƒƒã‚°å¯èƒ½ã«
        function makeTextDraggable(el) {
            let startX, startY, initialLeft, initialTop;
            let isDragging = false;
            
            const textContent = el.querySelector('span:not(.delete-text)');
            
            textContent.addEventListener('mousedown', dragStart);
            textContent.addEventListener('touchstart', dragStart, {passive: false});
            
            function dragStart(e) {
                isDragging = true;
                const rect = el.getBoundingClientRect();
                const containerRect = document.getElementById('canvasContainer').getBoundingClientRect();
                
                if (e.type === 'mousedown') {
                    startX = e.clientX;
                    startY = e.clientY;
                } else {
                    e.preventDefault();
                    startX = e.touches[0].clientX;
                    startY = e.touches[0].clientY;
                }
                
                initialLeft = rect.left - containerRect.left;
                initialTop = rect.top - containerRect.top;
                
                document.addEventListener('mousemove', drag);
                document.addEventListener('touchmove', drag, {passive: false});
                document.addEventListener('mouseup', dragEnd);
                document.addEventListener('touchend', dragEnd);
            }
            
            function drag(e) {
                if (!isDragging) return;
                
                let clientX, clientY;
                if (e.type === 'mousemove') {
                    clientX = e.clientX;
                    clientY = e.clientY;
                } else {
                    e.preventDefault();
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                }
                
                const deltaX = clientX - startX;
                const deltaY = clientY - startY;
                
                el.style.left = (initialLeft + deltaX) + 'px';
                el.style.top = (initialTop + deltaY) + 'px';
            }
            
            function dragEnd() {
                isDragging = false;
                document.removeEventListener('mousemove', drag);
                document.removeEventListener('touchmove', drag);
                document.removeEventListener('mouseup', dragEnd);
                document.removeEventListener('touchend', dragEnd);
            }
        }

        // ãƒ†ã‚­ã‚¹ãƒˆè¦ç´ ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
        function renderTextElements() {
            const container = document.getElementById('canvasContainer');
            document.querySelectorAll('.text-overlay').forEach(el => el.remove());
            
            if (textElements[currentView]) {
                textElements[currentView].forEach(data => {
                    const textEl = document.createElement('div');
                    textEl.className = 'text-overlay';
                    
                    const textSpan = document.createElement('span');
                    textSpan.textContent = data.text;
                    
                    const deleteBtn = document.createElement('span');
                    deleteBtn.className = 'delete-text';
                    deleteBtn.textContent = 'Ã—';
                    deleteBtn.addEventListener('click', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteTextElement(textEl, data.text);
                    });
                    deleteBtn.addEventListener('touchend', function(e) {
                        e.preventDefault();
                        e.stopPropagation();
                        deleteTextElement(textEl, data.text);
                    });
                    
                    textEl.appendChild(textSpan);
                    textEl.appendChild(deleteBtn);
                    textEl.style.position = 'absolute';
                    textEl.style.left = data.left;
                    textEl.style.top = data.top;
                    makeTextDraggable(textEl);
                    container.appendChild(textEl);
                });
            }
        }

        // ãƒ„ãƒ¼ãƒ«è¨­å®š
        function setTool(tool) {
            currentTool = tool;
            document.querySelectorAll('.tools button').forEach(btn => btn.classList.remove('active'));
            if (tool === 'pen') document.getElementById('penBtn').classList.add('active');
            if (tool === 'eraser') document.getElementById('eraserBtn').classList.add('active');
            if (tool === 'text') document.getElementById('textBtn').classList.add('active');
        }

        // è‰²è¨­å®š
        function setColor(color) {
            currentColor = color;
            currentTool = 'pen';
            setTool('pen');
            document.querySelectorAll('.color-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
        }

        // ç·šå¹…æ›´æ–°
        function updateLineWidth(value) {
            lineWidth = parseInt(value);
            document.getElementById('widthValue').textContent = value + 'px';
        }

        // ãƒ†ã‚­ã‚¹ãƒˆè¿½åŠ 
        function addText() {
            alert('ã‚­ãƒ£ãƒ³ãƒã‚¹ã‚’é•·æŠ¼ã—ï¼ˆ0.5ç§’ï¼‰ã—ã¦ãƒ†ã‚­ã‚¹ãƒˆã‚’è¿½åŠ ã—ã¦ãã ã•ã„');
        }

        // çŠ¶æ…‹ä¿å­˜
        function saveState() {
            if (!undoStacks[currentView]) undoStacks[currentView] = [];
            
            if (undoStacks[currentView].length >= MAX_UNDO + 1) {
                undoStacks[currentView].shift();
            }
            
            undoStacks[currentView].push(canvas.toDataURL());
            redoStacks[currentView] = [];
            updateUndoCounter();
        }

        // Undo
        function undo() {
            if (!undoStacks[currentView] || undoStacks[currentView].length <= 1) {
                alert('ã“ã‚Œä»¥ä¸Šæˆ»ã›ã¾ã›ã‚“ï¼ˆCrine Freeç‰ˆï¼šæœ€å¤§5å›ã¾ã§ï¼‰');
                return;
            }
            redoStacks[currentView].push(undoStacks[currentView].pop());
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = undoStacks[currentView][undoStacks[currentView].length - 1];
            updateUndoCounter();
        }

        // Redo
        function redo() {
            if (!redoStacks[currentView] || redoStacks[currentView].length === 0) {
                alert('ã‚„ã‚Šç›´ã›ã¾ã›ã‚“');
                return;
            }
            const state = redoStacks[currentView].pop();
            undoStacks[currentView].push(state);
            const img = new Image();
            img.onload = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                ctx.drawImage(img, 0, 0);
            };
            img.src = state;
            updateUndoCounter();
        }

        // Undoã‚«ã‚¦ãƒ³ã‚¿ãƒ¼æ›´æ–°
        function updateUndoCounter() {
            const count = undoStacks[currentView] ? Math.max(0, undoStacks[currentView].length - 1) : 0;
            document.getElementById('undoCounter').textContent = `Undo: ${count}/${MAX_UNDO}å›`;
        }

        // æç”»ä¿å­˜
        function saveDrawing() {
            const data = {
                customerId: customerId,
                drawings: undoStacks,
                textElements: textElements,
                timestamp: new Date().toISOString()
            };
            
            localStorage.setItem('drawing_' + customerId, JSON.stringify(data));
            alert('âœ… æç”»ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
        }

        // æç”»èª­ã¿è¾¼ã¿
        function loadDrawing() {
            const saved = localStorage.getItem('drawing_' + customerId);
            if (saved) {
                const data = JSON.parse(saved);
                if (data.drawings) {
                    undoStacks = data.drawings;
                    redoStacks = {};
                    Object.keys(undoStacks).forEach(view => {
                        redoStacks[view] = [];
                    });
                    
                    if (undoStacks[currentView] && undoStacks[currentView].length > 0) {
                        const img = new Image();
                        img.onload = function() {
                            ctx.clearRect(0, 0, canvas.width, canvas.height);
                            ctx.drawImage(img, 0, 0);
                        };
                        img.src = undoStacks[currentView][undoStacks[currentView].length - 1];
                    }
                    updateUndoCounter();
                }
                
                if (data.textElements) {
                    textElements = data.textElements;
                    renderTextElements();
                }
            }
        }

        // ã‚«ãƒ«ãƒ†ã«æˆ»ã‚‹
        function backToMain() {
            saveDrawing();
            window.location.href = 'index.html?id=' + customerId;
        }

        // ãƒšãƒ¼ã‚¸é›¢è„±æ™‚ã«è‡ªå‹•ä¿å­˜
        window.addEventListener('beforeunload', function() {
            saveDrawing();
        });
    </script>
</body>
</html>
