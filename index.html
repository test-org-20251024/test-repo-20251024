<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<meta http-equiv="Content-Security-Policy" content="
    default-src 'self';
    script-src 'self' 'unsafe-inline' https://pagead2.googlesyndication.com;
    style-src 'self' 'unsafe-inline';
    img-src 'self' data: https:;
    connect-src 'self';
">
<title>Crine Free - ãƒ¡ã‚¤ãƒ³ã‚«ãƒ«ãƒ†</title>
<style>
* { margin: 0; padding: 0; box-sizing: border-box; }
body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 10px; }
.container { max-width: 1200px; margin: 0 auto; background: white; border-radius: 20px; box-shadow: 0 20px 40px rgba(0,0,0,0.2); overflow: hidden; }
.header { background: linear-gradient(45deg, #48c6ef, #6f86d6); color: white; padding: 25px; text-align: center; position: relative; }
.header h1 { font-size: 28px; font-weight: 700; margin-bottom: 5px; }
.header p { font-size: 14px; opacity: 0.9; }
.free-badge { background: rgba(255,255,255,0.3); padding: 5px 15px; border-radius: 20px; display: inline-block; margin-top: 8px; font-size: 13px; }
.license-info { position: absolute; top: 10px; right: 15px; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 15px; font-size: 12px; }
.license-info-mobile { display: none; background: rgba(255,255,255,0.2); padding: 8px 15px; border-radius: 15px; font-size: 11px; margin-top: 10px; text-align: center; }
.logout-btn { background: rgba(255,255,255,0.3); border: none; color: white; padding: 5px 12px; border-radius: 12px; cursor: pointer; font-size: 11px; margin-left: 10px; }
.logout-btn:hover { background: rgba(255,255,255,0.4); }
.search-bar { background: rgba(255,255,255,0.15); padding: 20px 25px; }
.search-input { width: 100%; padding: 12px 20px; border: none; border-radius: 25px; font-size: 16px; }
.sidebar { width: 100%; background: white; padding: 20px; }
.section { background: white; border-radius: 15px; padding: 20px; margin-bottom: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.08); border-left: 4px solid #667eea; }
.section h3 { color: #2d3436; margin-bottom: 20px; font-size: 18px; font-weight: 700; }
.form-group { margin-bottom: 18px; }
.form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: #2d3436; font-size: 14px; }
.form-group input, .form-group textarea { width: 100%; padding: 12px 15px; border: 2px solid #ddd; border-radius: 10px; font-size: 16px; font-family: inherit; }
.form-group input:focus, .form-group textarea:focus { outline: none; border-color: #667eea; }
.form-row { display: flex; gap: 15px; }
.form-row .form-group { flex: 1; }
.menu-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-bottom: 15px; }
.menu-checkbox { display: flex; align-items: center; gap: 8px; padding: 12px; background: #f8f9fa; border-radius: 8px; cursor: pointer; }
.menu-checkbox input { width: 20px; height: 20px; cursor: pointer; }
.menu-checkbox label { cursor: pointer; font-weight: 600; font-size: 14px; }
.detail-box { background: #f0f3ff; border: 2px solid #667eea; border-radius: 12px; padding: 15px; margin-top: 15px; }
.detail-box h4 { color: #667eea; font-size: 15px; margin-bottom: 12px; }
.rod-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin-top: 10px; }
.action-buttons { display: flex; gap: 15px; margin: 30px 0; flex-wrap: wrap; }
.btn { flex: 1; min-width: 150px; padding: 15px; border: none; border-radius: 25px; font-size: 16px; font-weight: 700; cursor: pointer; transition: all 0.3s ease; }
.btn:hover { transform: translateY(-2px); box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
.btn-primary { background: #00b894; color: white; }
.btn-secondary { background: #74b9ff; color: white; }
.btn-warning { background: #fdcb6e; color: white; }
.btn-danger { background: #ff7675; color: white; }
.btn-drawing { background: linear-gradient(135deg, #f093fb, #f5576c); color: white; }
.customer-item { padding: 15px; border: 2px solid #ddd; border-radius: 12px; margin-bottom: 12px; cursor: pointer; background: white; transition: all 0.3s ease; }
.customer-item:hover { border-color: #667eea; background: #f8f9ff; transform: translateX(5px); }
.storage-info { background: #fff3cd; border: 2px solid #ffc107; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center; font-weight: 600; color: #856404; }
.limit-warning { background: #f8d7da; border: 2px solid #f5c6cb; border-radius: 10px; padding: 15px; margin-bottom: 20px; text-align: center; font-weight: 600; color: #721c24; }
.ad-container { background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%); border-radius: 15px; padding: 20px; margin: 20px 0; box-shadow: 0 5px 15px rgba(0,0,0,0.1); }
.ad-label { font-size: 11px; color: #666; margin-bottom: 12px; text-align: center; text-transform: uppercase; letter-spacing: 1.5px; font-weight: 600; }
.ad-content { background: white; border-radius: 12px; padding: 20px; min-height: 250px; display: flex; align-items: center; justify-content: center; color: #999; font-size: 14px; }
@media (max-width: 768px) {
    .license-info { display: none; }
    .license-info-mobile { display: block; }
    .form-row { flex-direction: column; }
    .menu-grid { grid-template-columns: 1fr; }
    .rod-grid { grid-template-columns: 1fr; }
}
</style>
</head>
<body>
<div class="container">
<div class="header">
<div class="license-info" id="licenseInfoDesktop">
<span id="planNameDesktop">Freeç‰ˆ</span>
<button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>
<h1>ğŸ’‡â€â™€ï¸ Crine Free</h1>
<p>ç¾å®¹å¸«å‘ã‘é›»å­ã‚«ãƒ«ãƒ†ã‚·ã‚¹ãƒ†ãƒ </p>
<div class="free-badge" id="planBadge">Crine Freeç‰ˆ - é¡§å®¢10åã¾ã§ | ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜20å›åˆ†</div>
<div class="license-info-mobile" id="licenseInfoMobile">
<span id="planNameMobile">Freeç‰ˆ</span>
<button class="logout-btn" onclick="logout()">ãƒ­ã‚°ã‚¢ã‚¦ãƒˆ</button>
</div>
</div>
<div class="search-bar">
<input type="text" class="search-input" id="globalSearch" placeholder="ãŠå®¢æ§˜ã®åå‰ã¾ãŸã¯IDã§æ¤œç´¢...">
</div>
<div class="sidebar">
<div class="storage-info" id="storageInfo">ç™»éŒ²é¡§å®¢æ•°: 0/10 | ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜: 0/20å›åˆ†</div>
<div id="limitWarning" class="limit-warning" style="display:none">âš ï¸ Freeç‰ˆã®ä¸Šé™ï¼ˆ10åï¼‰ã«é”ã—ã¦ã„ã¾ã™</div>
<div class="ad-container">
<div class="ad-label">ã‚¹ãƒãƒ³ã‚µãƒ¼åºƒå‘Š</div>
<div class="ad-content">
<ins class="adsbygoogle" style="display:block" data-ad-client="ca-pub-XXXXXXXXXX" data-ad-slot="XXXXXXXXXX" data-ad-format="auto" data-full-width-responsive="true"></ins>
</div>
</div>
<div class="section">
<h3>ğŸ‘¤ ãŠå®¢æ§˜æƒ…å ±</h3>
<div class="form-group"><label>é¡§å®¢ID</label><input type="text" id="customerId" readonly style="background:#f0f0f0"></div>
<div class="form-group"><label>ãŠåå‰ *</label><input type="text" id="customerName" placeholder="å±±ç”° èŠ±å­"></div>
<div class="form-row">
<div class="form-group"><label>å¹´é½¢</label><input type="number" id="customerAge" placeholder="25"></div>
<div class="form-group"><label>æ¥åº—æ—¥ *</label><input type="date" id="visitDate"></div>
</div>
<div class="form-group"><label>æ‹…å½“ã‚¹ã‚¿ã‚¤ãƒªã‚¹ãƒˆ</label><input type="text" id="stylistName" placeholder="ç”°ä¸­"></div>
</div>
<div class="section">
<h3>âœ‚ï¸ æ–½è¡“ãƒ¡ãƒ‹ãƒ¥ãƒ¼</h3>
<div class="menu-grid">
<div class="menu-checkbox"><input type="checkbox" id="menuCut" value="ã‚«ãƒƒãƒˆ"><label for="menuCut">ã‚«ãƒƒãƒˆ</label></div>
<div class="menu-checkbox"><input type="checkbox" id="menuColor" value="ã‚«ãƒ©ãƒ¼"><label for="menuColor">ã‚«ãƒ©ãƒ¼</label></div>
<div class="menu-checkbox"><input type="checkbox" id="menuPerm" value="ãƒ‘ãƒ¼ãƒ"><label for="menuPerm">ãƒ‘ãƒ¼ãƒ</label></div>
<div class="menu-checkbox"><input type="checkbox" id="menuTreatment" value="ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ"><label for="menuTreatment">ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆ</label></div>
<div class="menu-checkbox"><input type="checkbox" id="menuStraight" value="ç¸®æ¯›çŸ¯æ­£"><label for="menuStraight">ç¸®æ¯›çŸ¯æ­£</label></div>
<div class="menu-checkbox"><input type="checkbox" id="menuHeadSpa" value="ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘"><label for="menuHeadSpa">ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘</label></div>
<div class="menu-checkbox"><input type="checkbox" id="menuSet" value="ã‚»ãƒƒãƒˆ"><label for="menuSet">ã‚»ãƒƒãƒˆ</label></div>
<div class="menu-checkbox"><input type="checkbox" id="menuOther" value="ãã®ä»–"><label for="menuOther">ãã®ä»–</label></div>
</div>
<div class="form-row">
<div class="form-group"><label>æ–™é‡‘ï¼ˆå††ï¼‰</label><input type="number" id="servicePrice" placeholder="8000"></div>
<div class="form-group"><label>æ–½è¡“æ™‚é–“ï¼ˆåˆ†ï¼‰</label><input type="number" id="serviceTime" placeholder="120"></div>
</div>
</div>
<div class="section">
<h3>ğŸ¨ ã‚«ãƒ©ãƒ¼æƒ…å ±</h3>
<div class="form-group"><label>ã‚«ãƒ©ãƒ¼1</label><input type="text" id="color1" placeholder="ä¾‹: ã‚¢ãƒƒã‚·ãƒ¥ãƒ–ãƒ©ã‚¦ãƒ³ 7ãƒ¬ãƒ™ãƒ«"></div>
<div class="form-group"><label>ã‚«ãƒ©ãƒ¼2</label><input type="text" id="color2" placeholder="ä¾‹: ãƒã‚¤ãƒ©ã‚¤ãƒˆ ãƒ™ãƒ¼ã‚¸ãƒ¥"></div>
<div class="form-group"><label>ã‚«ãƒ©ãƒ¼å‚™è€ƒ</label><textarea id="colorNotes" rows="3" placeholder="ä¾‹: æ ¹å…ƒã¯æš—ã‚ã«ã€æ¯›å…ˆã¯æ˜ã‚‹ã‚"></textarea></div>
</div>
<div class="section">
<h3>âœ¨ ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆæƒ…å ±</h3>
<div class="form-group"><label>ãƒˆãƒªãƒ¼ãƒˆãƒ¡ãƒ³ãƒˆå‚™è€ƒ</label><textarea id="treatmentNotes" rows="3"></textarea></div>
</div>
<div class="section">
<h3>ğŸ“ ç¸®æ¯›çŸ¯æ­£æƒ…å ±</h3>
<div class="form-group"><label>è–¬æ¶²1</label><input type="text" id="straightDrug1"></div>
<div class="form-group"><label>è–¬æ¶²2</label><input type="text" id="straightDrug2"></div>
<div class="form-group"><label>ç¸®æ¯›çŸ¯æ­£å‚™è€ƒ</label><textarea id="straightNotes" rows="3"></textarea></div>
</div>
<div class="section">
<h3>ğŸ’† ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘æƒ…å ±</h3>
<div class="form-group"><label>ãƒ˜ãƒƒãƒ‰ã‚¹ãƒ‘å‚™è€ƒ</label><textarea id="spaNote" rows="3"></textarea></div>
</div>
<div class="section">
<h3>ğŸŒ€ ãƒ‘ãƒ¼ãƒè©³ç´°è¨˜éŒ²</h3>
<div class="form-group"><label>ğŸ’Š è–¬å‰¤</label><textarea id="chemical" rows="2"></textarea></div>
<div class="detail-box">
<h4>ğŸ¯ ãƒ­ãƒƒãƒ‰è©³ç´°ï¼ˆéƒ¨ä½åˆ¥16ç®‡æ‰€ï¼‰</h4>
<div class="rod-grid">
<div class="form-group"><label>å‰é«ª</label><input type="text" id="rod0"></div>
<div class="form-group"><label>ãƒ•ãƒ­ãƒ³ãƒˆ</label><input type="text" id="rod1"></div>
<div class="form-group"><label>å³ã‚µã‚¤ãƒ‰ä¸Š</label><input type="text" id="rod2"></div>
<div class="form-group"><label>å³ã‚µã‚¤ãƒ‰ä¸‹</label><input type="text" id="rod3"></div>
<div class="form-group"><label>å·¦ã‚µã‚¤ãƒ‰ä¸Š</label><input type="text" id="rod4"></div>
<div class="form-group"><label>å·¦ã‚µã‚¤ãƒ‰ä¸‹</label><input type="text" id="rod5"></div>
<div class="form-group"><label>ãƒˆãƒƒãƒ—</label><input type="text" id="rod6"></div>
<div class="form-group"><label>ã‚¯ãƒ©ã‚¦ãƒ³</label><input type="text" id="rod7"></div>
<div class="form-group"><label>ãƒãƒƒã‚¯</label><input type="text" id="rod8"></div>
<div class="form-group"><label>å³ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸Š</label><input type="text" id="rod9"></div>
<div class="form-group"><label>å³ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸‹</label><input type="text" id="rod10"></div>
<div class="form-group"><label>å·¦ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸Š</label><input type="text" id="rod11"></div>
<div class="form-group"><label>å·¦ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸‹</label><input type="text" id="rod12"></div>
<div class="form-group"><label>ãƒãƒ¼ãƒ—</label><input type="text" id="rod13"></div>
<div class="form-group"><label>å³ãƒãƒ¼ãƒ—</label><input type="text" id="rod14"></div>
<div class="form-group"><label>å·¦ãƒãƒ¼ãƒ—</label><input type="text" id="rod15"></div>
</div>
</div>
<div class="form-group"><label>æ”¾ç½®æ™‚é–“</label><input type="text" id="processTime"></div>
<div class="form-group"><label>ä»•ä¸ŠãŒã‚ŠçŠ¶æ…‹</label><input type="text" id="finishState"></div>
</div>
<div class="section">
<h3>ğŸ“ å‚™è€ƒ</h3>
<div class="form-group"><label>å‚™è€ƒ1</label><textarea id="notes1" rows="3"></textarea></div>
<div class="form-group"><label>å‚™è€ƒ2</label><textarea id="notes2" rows="3"></textarea></div>
</div>
<div class="action-buttons">
<button class="btn btn-primary" id="saveBtn">ğŸ’¾ ä¿å­˜</button>
<button class="btn btn-drawing" id="drawingBtn">ğŸ¨ æç”»ã‚¢ãƒ—ãƒª</button>
<button class="btn btn-secondary" id="dataStorageBtn">ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ä¿å­˜</button>
<button class="btn btn-secondary" id="backupBtn">ğŸ“¥ ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—DL</button>
<button class="btn btn-warning" id="restoreBtn">ğŸ“¤ å¾©å…ƒ</button>
<button class="btn btn-secondary" id="newBtn">â• æ–°è¦é¡§å®¢</button>
<button class="btn btn-danger" id="deleteBtn">ğŸ—‘ï¸ å‰Šé™¤</button>
<button class="btn btn-danger" id="bugReportBtn" style="background: #e74c3c;">ğŸ› ãƒã‚°å ±å‘Š</button>
</div>
<div class="section">
<h3>ğŸ“‹ é¡§å®¢ä¸€è¦§</h3>
<div class="form-group"><input type="text" id="customerSearch" class="search-input" placeholder="é¡§å®¢åã§æ¤œç´¢..."></div>
<div id="customerList" style="max-height:400px;overflow-y:auto"></div>
</div>
</div>
</div>
<input type="file" id="restoreFile" accept=".json" style="display:none">
<script>
function checkAuth() {
    const authInfo = localStorage.getItem('salonLicense');
    if (!authInfo) {
        alert('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹èªè¨¼ãŒå¿…è¦ã§ã™ã€‚èªè¨¼ãƒšãƒ¼ã‚¸ã¸ç§»å‹•ã—ã¾ã™ã€‚');
        window.location.href = 'license.html';
        return false;
    }
    try {
        const auth = JSON.parse(authInfo);
        if (new Date(auth.validUntil) < new Date()) {
            alert('ãƒ©ã‚¤ã‚»ãƒ³ã‚¹ã®æœ‰åŠ¹æœŸé™ãŒåˆ‡ã‚Œã¦ã„ã¾ã™ã€‚å†èªè¨¼ãŒå¿…è¦ã§ã™ã€‚');
            localStorage.removeItem('salonLicense');
            window.location.href = 'license.html';
            return false;
        }
        displayLicenseInfo(auth);
        return true;
    } catch (e) {
        console.error('èªè¨¼ã‚¨ãƒ©ãƒ¼:', e);
        localStorage.removeItem('salonLicense');
        window.location.href = 'license.html';
        return false;
    }
}

function displayLicenseInfo(auth) {
    const planDisplay = auth.planName || 'Freeç‰ˆ';
    const validDate = new Date(auth.validUntil).toLocaleDateString('ja-JP');
    document.getElementById('planNameDesktop').textContent = planDisplay + ' (æœ‰åŠ¹æœŸé™: ' + validDate + ')';
    document.getElementById('planNameMobile').textContent = planDisplay;
    const badge = document.getElementById('planBadge');
    if (auth.plan === 'free') {
        badge.textContent = 'FREEç‰ˆ - é¡§å®¢10åã¾ã§ | ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜20å›åˆ†';
    } else if (auth.plan === 'basic') {
        badge.textContent = 'BASICç‰ˆ - é¡§å®¢50åã¾ã§ | LINEé€£æºå¯¾å¿œ';
    } else if (auth.plan === 'pro') {
        badge.textContent = 'PROç‰ˆ - é¡§å®¢ç„¡åˆ¶é™ | ãƒªã‚¢ãƒ«2Dã‚¤ãƒ©ã‚¹ãƒˆ | è‡ªå‹•åŒæœŸ';
    } else if (auth.plan === 'premium') {
        badge.textContent = 'PREMIUMç‰ˆ - å…¨æ©Ÿèƒ½ | ãƒãƒ¼ãƒ å¯¾å¿œ | å„ªå…ˆã‚µãƒãƒ¼ãƒˆ';
    }
}

function logout() {
    if (!confirm('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã™ã‹ï¼Ÿ')) return;
    localStorage.removeItem('salonLicense');
    alert('ãƒ­ã‚°ã‚¢ã‚¦ãƒˆã—ã¾ã—ãŸ');
    window.location.href = 'license.html';
}

let customers = [];
let currentCustomerId = null;
const MAX_CUSTOMERS = 10;
const MAX_BROWSER_STORAGE = 20;
const rodPositions = ['å‰é«ª','ãƒ•ãƒ­ãƒ³ãƒˆ','å³ã‚µã‚¤ãƒ‰ä¸Š','å³ã‚µã‚¤ãƒ‰ä¸‹','å·¦ã‚µã‚¤ãƒ‰ä¸Š','å·¦ã‚µã‚¤ãƒ‰ä¸‹','ãƒˆãƒƒãƒ—','ã‚¯ãƒ©ã‚¦ãƒ³','ãƒãƒƒã‚¯','å³ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸Š','å³ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸‹','å·¦ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸Š','å·¦ãƒãƒƒã‚¯ã‚µã‚¤ãƒ‰ä¸‹','ãƒãƒ¼ãƒ—','å³ãƒãƒ¼ãƒ—','å·¦ãƒãƒ¼ãƒ—'];

window.onload = function() {
    if (!checkAuth()) return;
    initSystem();
    loadAdScript();
};

function loadAdScript() {}

function initSystem() {
    generateCustomerId();
    setTodayDate();
    loadCustomers();
    updateDisplay();
    setupEventListeners();
}

function setupEventListeners() {
    document.getElementById('saveBtn').onclick = saveCustomer;
    document.getElementById('drawingBtn').onclick = openDrawing;
    document.getElementById('dataStorageBtn').onclick = openDataStorage;
    document.getElementById('backupBtn').onclick = downloadBackup;
    document.getElementById('restoreBtn').onclick = () => document.getElementById('restoreFile').click();
    document.getElementById('restoreFile').onchange = restoreFromFile;
    document.getElementById('newBtn').onclick = newCustomer;
    document.getElementById('deleteBtn').onclick = deleteCustomer;
    document.getElementById('bugReportBtn').onclick = openBugReport;
    document.getElementById('customerSearch').oninput = function() { displayCustomerList(this.value); };
    document.getElementById('globalSearch').oninput = function() { displayCustomerList(this.value); };
}

function generateCustomerId() {
    const id = 'C' + Date.now().toString().slice(-8);
    document.getElementById('customerId').value = id;
    currentCustomerId = id;
}

function setTodayDate() {
    document.getElementById('visitDate').value = new Date().toISOString().split('T')[0];
}

function loadCustomers() {
    const s = localStorage.getItem('salonCustomersFree');
    if (s) {
        customers = JSON.parse(s);
        if (customers.length > MAX_BROWSER_STORAGE) {
            customers = customers.slice(-MAX_BROWSER_STORAGE);
        }
    }
}

function saveToLocalStorage() {
    localStorage.setItem('salonCustomersFree', JSON.stringify(customers.slice(-MAX_BROWSER_STORAGE)));
}

async function saveCustomer() {
    const name = document.getElementById('customerName').value.trim();
    const date = document.getElementById('visitDate').value;
    if (!name || !date) {
        alert('å¿…é ˆé …ç›®ï¼ˆãŠåå‰ãƒ»æ¥åº—æ—¥ï¼‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');
        return;
    }
    const idx = customers.findIndex(c => c.id === currentCustomerId);
    if (idx === -1 && customers.length >= MAX_CUSTOMERS) {
        alert('Freeç‰ˆã¯æœ€å¤§10åã¾ã§ã§ã™ã€‚Basicç‰ˆã¸ã®ã‚¢ãƒƒãƒ—ã‚°ãƒ¬ãƒ¼ãƒ‰ã‚’ã”æ¤œè¨ãã ã•ã„ã€‚');
        return;
    }
    const menus = [];
    ['menuCut','menuColor','menuPerm','menuTreatment','menuStraight','menuHeadSpa','menuSet','menuOther'].forEach(id => {
        const cb = document.getElementById(id);
        if (cb.checked) menus.push(cb.value);
    });
    const rods = rodPositions.map((p, i) => ({
        position: p,
        rod: document.getElementById('rod' + i).value
    }));
    const drawings = await getDrawingData(currentCustomerId);
    const data = {
        id: currentCustomerId,
        name,
        age: document.getElementById('customerAge').value,
        date,
        stylist: document.getElementById('stylistName').value,
        menus,
        price: document.getElementById('servicePrice').value,
        time: document.getElementById('serviceTime').value,
        color1: document.getElementById('color1').value,
        color2: document.getElementById('color2').value,
        colorNotes: document.getElementById('colorNotes').value,
        treatmentNotes: document.getElementById('treatmentNotes').value,
        straightDrug1: document.getElementById('straightDrug1').value,
        straightDrug2: document.getElementById('straightDrug2').value,
        straightNotes: document.getElementById('straightNotes').value,
        spaNote: document.getElementById('spaNote').value,
        chemical: document.getElementById('chemical').value,
        rods,
        processTime: document.getElementById('processTime').value,
        finishState: document.getElementById('finishState').value,
        notes1: document.getElementById('notes1').value,
        notes2: document.getElementById('notes2').value,
        timestamp: new Date().toISOString(),
        drawings
    };
    if (idx >= 0) {
        customers[idx] = data;
    } else {
        customers.push(data);
    }
    saveToLocalStorage();
    updateDisplay();
    alert('ä¿å­˜å®Œäº†ã—ã¾ã—ãŸï¼');
    if (confirm('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã‚’ãƒ€ã‚¦ãƒ³ãƒ­ãƒ¼ãƒ‰ã—ã¾ã™ã‹ï¼Ÿ')) {
        downloadBackup();
    }
}

async function getDrawingData(id) {
    const s = localStorage.getItem('drawing_' + id);
    if (!s) return null;
    const d = JSON.parse(s);
    if (!d.drawings) return null;
    const r = {};
    ['front','back','left','right','top','diagonal-left','diagonal-right','diagonal-left-back','diagonal-right-back'].forEach(v => {
        if (d.drawings[v] && d.drawings[v].length > 0) {
            r[v] = d.drawings[v][d.drawings[v].length - 1];
        }
    });
    return r;
}

function openDrawing() {
    if (!currentCustomerId) {
        alert('å…ˆã«é¡§å®¢æƒ…å ±ã‚’ä¿å­˜ã—ã¦ãã ã•ã„');
        return;
    }
    window.location.href = 'drawing.html?id=' + currentCustomerId;
}

function openDataStorage() {
    window.location.href = 'data-storage.html';
}

function openBugReport() {
    window.location.href = 'bug-report.html';
}

function downloadBackup() {
    if (!customers.length) {
        alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ã™ã‚‹ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
    }
    const authInfo = JSON.parse(localStorage.getItem('salonLicense') || '{}');
    const b = {
        version: 'free',
        brand: 'Crine',
        plan: authInfo.plan || 'free',
        exportDate: new Date().toISOString(),
        totalRecords: customers.length,
        customers
    };
    const blob = new Blob([JSON.stringify(b, null, 2)], { type: 'application/json' });
    const url = URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = 'crine_free_backup_' + new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5) + '.json';
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
    alert('ãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—å®Œäº†ï¼');
}

function restoreFromFile(e) {
    const f = e.target.files[0];
    if (!f) return;
    if (!confirm('ç¾åœ¨ã®ãƒ‡ãƒ¼ã‚¿ã¯ä¸Šæ›¸ãã•ã‚Œã¾ã™ã€‚å¾©å…ƒã—ã¾ã™ã‹ï¼Ÿ')) {
        e.target.value = '';
        return;
    }
    const r = new FileReader();
    r.onload = function(ev) {
        try {
            const b = JSON.parse(ev.target.result);
            if (!b.customers || !Array.isArray(b.customers)) {
                alert('ç„¡åŠ¹ãªãƒãƒƒã‚¯ã‚¢ãƒƒãƒ—ãƒ•ã‚¡ã‚¤ãƒ«ã§ã™');
                return;
            }
            customers = b.customers;
            saveToLocalStorage();
            customers.forEach(c => {
                if (c.drawings) {
                    const d = {
                        customerId: c.id,
                        drawings: {},
                        timestamp: c.timestamp
                    };
                    ['front','back','left','right','top','diagonal-left','diagonal-right','diagonal-left-back','diagonal-right-back'].forEach(v => {
                        if (c.drawings[v]) {
                            d.drawings[v] = [c.drawings[v]];
                        }
                    });
                    localStorage.setItem('drawing_' + c.id, JSON.stringify(d));
                }
            });
            updateDisplay();
            alert('å¾©å…ƒå®Œäº†ï¼');
        } catch (err) {
            console.error('å¾©å…ƒã‚¨ãƒ©ãƒ¼:', err);
            alert('ãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ');
        }
    };
    r.readAsText(f);
    e.target.value = '';
}

function newCustomer() {
    if (!confirm('æ–°è¦é¡§å®¢ã‚’ä½œæˆã—ã¾ã™ã‹ï¼Ÿç¾åœ¨ã®ç·¨é›†å†…å®¹ã¯å¤±ã‚ã‚Œã¾ã™ã€‚')) return;
    currentCustomerId = null;
    document.querySelectorAll('input[type="text"],input[type="number"],input[type="date"],textarea').forEach(i => {
        if (i.id !== 'customerId' && i.id !== 'customerSearch' && i.id !== 'globalSearch') {
            i.value = '';
        }
    });
    document.querySelectorAll('input[type="checkbox"]').forEach(c => c.checked = false);
    generateCustomerId();
    setTodayDate();
}

function deleteCustomer() {
    if (!currentCustomerId) {
        alert('å‰Šé™¤ã™ã‚‹é¡§å®¢ã‚’é¸æŠã—ã¦ãã ã•ã„');
        return;
    }
    const c = customers.find(x => x.id === currentCustomerId);
    if (!c) {
        alert('é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        return;
    }
    if (!confirm(c.name + 'æ§˜ã®ãƒ‡ãƒ¼ã‚¿ã‚’å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚')) return;
    customers = customers.filter(x => x.id !== currentCustomerId);
    localStorage.removeItem('drawing_' + currentCustomerId);
    saveToLocalStorage();
    updateDisplay();
    alert('å‰Šé™¤ã—ã¾ã—ãŸ');
    newCustomer();
}

function loadCustomerData(d) {
    currentCustomerId = d.id;
    document.getElementById('customerId').value = d.id || '';
    document.getElementById('customerName').value = d.name || '';
    document.getElementById('customerAge').value = d.age || '';
    document.getElementById('visitDate').value = d.date || '';
    document.getElementById('stylistName').value = d.stylist || '';
    document.querySelectorAll('input[type="checkbox"]').forEach(c => {
        c.checked = d.menus && d.menus.includes(c.value);
    });
    document.getElementById('servicePrice').value = d.price || '';
    document.getElementById('serviceTime').value = d.time || '';
    document.getElementById('color1').value = d.color1 || '';
    document.getElementById('color2').value = d.color2 || '';
    document.getElementById('colorNotes').value = d.colorNotes || '';
    document.getElementById('treatmentNotes').value = d.treatmentNotes || '';
    document.getElementById('straightDrug1').value = d.straightDrug1 || '';
    document.getElementById('straightDrug2').value = d.straightDrug2 || '';
    document.getElementById('straightNotes').value = d.straightNotes || '';
    document.getElementById('spaNote').value = d.spaNote || '';
    document.getElementById('chemical').value = d.chemical || '';
    if (d.rods) {
        d.rods.forEach((r, i) => {
            const inp = document.getElementById('rod' + i);
            if (inp) inp.value = r.rod || '';
        });
    }
    document.getElementById('processTime').value = d.processTime || '';
    document.getElementById('finishState').value = d.finishState || '';
    document.getElementById('notes1').value = d.notes1 || '';
    document.getElementById('notes2').value = d.notes2 || '';
    window.scrollTo({ top: 0, behavior: 'smooth' });
}

function updateDisplay() {
    document.getElementById('storageInfo').textContent = 
        'ç™»éŒ²é¡§å®¢æ•°: ' + customers.length + '/' + MAX_CUSTOMERS + 
        ' | ãƒ–ãƒ©ã‚¦ã‚¶ä¿å­˜: ' + Math.min(customers.length, MAX_BROWSER_STORAGE) + '/' + MAX_BROWSER_STORAGE + 'å›åˆ†';
    document.getElementById('limitWarning').style.display = 
        customers.length >= MAX_CUSTOMERS ? 'block' : 'none';
    displayCustomerList();
}

function displayCustomerList(s = '') {
    const l = document.getElementById('customerList');
    if (!customers.length) {
        l.innerHTML = '<div style="text-align:center;color:#999;padding:20px">é¡§å®¢ãƒ‡ãƒ¼ã‚¿ãŒã‚ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    const f = customers.filter(c => 
        !s || 
        c.name.includes(s) || 
        c.id.includes(s) || 
        (c.stylist && c.stylist.includes(s))
    );
    if (!f.length) {
        l.innerHTML = '<div style="text-align:center;color:#999;padding:20px">æ¤œç´¢çµæœãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>';
        return;
    }
    f.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
    l.innerHTML = f.map(c => {
        const hasDrawing = c.drawings && Object.keys(c.drawings).length > 0;
        const drawingBadge = hasDrawing ? '<span style="background:#f093fb;color:white;padding:3px 8px;border-radius:10px;font-size:11px;margin-left:8px">ğŸ¨ æç”»æ¸ˆ</span>' : '';
        return `<div class="customer-item" onclick='loadCustomerData(${JSON.stringify(c).replace(/'/g, "&apos;")})'>\
<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:5px">\
<div style="font-weight:700;font-size:16px">${c.name}${drawingBadge}</div>\
<div style="font-size:12px;color:#999">${new Date(c.timestamp).toLocaleDateString('ja-JP')}</div>\
</div>\
<div style="font-size:13px;opacity:0.8">ID: ${c.id}</div>\
<div style="font-size:13px;opacity:0.8">æ¥åº—æ—¥: ${c.date || 'æœªè¨­å®š'}</div>\
${c.menus && c.menus.length ? '<div style="font-size:12px;opacity:0.7;margin-top:5px">æ–½è¡“: ' + c.menus.join(', ') + '</div>' : ''}\
</div>`;
    }).join('');
}
</script>
</body>
</html>
